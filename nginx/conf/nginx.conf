
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    # Declare Server
    upstream authentication {
        server localhost:8001;
        # server backend2.example.com;
    }

    upstream userService {
        server localhost:8002;
        # server backend2.example.com;
    }

    upstream eventService {
        server localhost:8003;
        # server backend2.example.com;
    }
    upstream gameService {
        server localhost:8004;
        # server backend2.example.com;
    }
    upstream notificationService {
        server localhost:8005;
        # server backend2.example.com;
    }
    upstream mcService {
        server localhost:8007;
        # server backend2.example.com;
    }
    upstream reportService {
        server localhost:8008;
        # server backend2.example.com;
    }

    # Public location
    map $request_uri $auth_required {
        default 0; #1 la true
        # ~^(.*)/auth 0;
        ~^/tien 0;
    }

    server {
        listen       8000;
        # server_name  localhost;

        set $cors_origin "";

        # List of allowed origins
        if ($http_origin ~* "http?://(localhost:5173|localhost:8081)") {
            set $cors_origin $http_origin;
        }

        # verify token
        location = /verify {
            internal;
            proxy_pass http://authentication/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";  
            # proxy_set_header X-Original-URI $request_uri;
            # proxy_set_header Authorization $http_authorization;
            proxy_set_header Host $host;
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        } 

        location /api {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, OPTIONS';
                #
                # Custom headers and headers various browsers should be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                add_header 'Access-Control-Allow-Credentials' 'true';
                return 204;
            }

            if ($auth_required) {
               rewrite ^/api(.*)$ /secure$1 last;
            }
            # return 200 'OK';
            rewrite ^/api(.*)$ /public$1 last;
            
        }

        location /secure {
            internal;
            auth_request /verify;
            auth_request_set $auth_status $upstream_status;

            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
            add_header 'Access-Control-Allow-Credentials' 'true';
            
            rewrite ^/secure(.*)$ $1 break;

            location /secure/auth {
                proxy_pass http://authentication$1;
            }

            location /secure/profile {
                proxy_pass http://userService$1;
                
            }

            location /secure/event {
                proxy_pass http://eventService$1;
            }

            location /secure/game {
                proxy_pass http://gameService$1;
            }

            location /secure/notification {
                proxy_pass http://notificationService$1;
            }

            location /secure/mc {
                proxy_pass http://mcService$1;
            }

            location /secure/report {
                proxy_pass http://reportService$1;
            }                              
        }


        location /public {
            internal;
            rewrite ^/public(.*)$ $1 break;

            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
            add_header 'Access-Control-Allow-Credentials' 'true';
            
            location /public/auth {
                proxy_pass http://authentication$1;
            }

            location /public/otp {
                proxy_pass http://authentication$1;
            }

            location /public/profile {
                proxy_pass http://userService$1;
                
            }

            location /public/event {
                proxy_pass http://eventService$1;
            }

            location /public/game {
                proxy_pass http://gameService$1;
            }

            location /public/notification {
                proxy_pass http://notificationService$1;
            }

            location /public/mc {
                proxy_pass http://mcService$1;
            }

            location /public/report {
                proxy_pass http://reportService$1;
            } 
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # Set location xu ly loi 401, 403
        error_page 401 @error401;
        error_page 403 @error403;

        # Location xử lý lỗi 401
        location @error401 {
            internal;
            return 401 'Unauthorized quan qua';
        }

        # Location xử lý lỗi 403
        location @error403 {
            internal;
            return 403 'Forbidden quan qua';
        }

    }
}
